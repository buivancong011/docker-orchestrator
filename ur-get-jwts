#!/usr/bin/env bash
set -Eeuo pipefail

# ============= CONFIG =============
UR_API="${UR_API:-https://api.bringyour.com}"
AUTH_CODE="${AUTH_CODE:-}"                          # ưu tiên nếu có
USER_AUTH="${USER_AUTH:-buivancong012@gmail.com}"
PASSWORD="${PASSWORD:-buivancong012}"

SBOX_PREFIX="${SBOX_PREFIX:-csbox}"                 # dùng khi COUNT có giá trị
COUNT="${COUNT:-}"                                  # ví dụ 30 -> csbox1..csbox30
ROUTES="${ROUTES:-}"                                # ví dụ "csbox1,csbox2,csbox5-10"
JWT_DIR_BASE="${JWT_DIR_BASE:-$HOME}"

ADMIN_JWT_FILE="${ADMIN_JWT_FILE:-$HOME/.urnetwork-admin.jwt}"
ADMIN_JWT_RENEW_BEFORE="${ADMIN_JWT_RENEW_BEFORE:-600}"
CLIENT_JWT_RENEW_BEFORE="${CLIENT_JWT_RENEW_BEFORE:-86400}"
DEBUG="${DEBUG:-false}"

# ============= UTILS =============
die(){ echo "[ERR] $*" >&2; exit 1; }
info(){ echo "[INFO] $*"; }
warn(){ echo "⚠ $*"; }
need(){ command -v "$1" >/dev/null 2>&1 || die "Thiếu lệnh '$1'."; }
now_ts(){ date +%s; }

jwt_payload_json(){
  local jwt="$1" p pad
  p="$(printf '%s' "$jwt" | cut -d. -f2)"
  pad=$(( (4 - (${#p} % 4)) % 4 ))
  p="${p}$(printf '=%.0s' $(seq 1 $pad))"
  printf '%s' "$p" | tr '_-' '/+' | base64 -d 2>/dev/null || true
}
jwt_exp_ts(){ jwt_payload_json "$1" | jq -r '.exp // empty'; }
# 0 = sắp hết hạn; 1 = KHÔNG sắp
jwt_about_to_expire(){
  local jwt="$1" th="$2" exp now
  exp="$(jwt_exp_ts "$jwt")"
  [[ -z "$exp" ]] && return 1
  now="$(now_ts)"
  (( exp - now <= th ))
}

# Sinh danh sách từ COUNT
gen_from_count(){
  local n="${1:?}" pfx="${2:?}"
  for i in $(seq 1 "$n"); do echo "${pfx}${i}"; done
}

# Parse ROUTES="csbox1,csbox5-10,csbox12"
gen_from_routes(){
  local spec="$1" part a b base
  IFS=',' read -r -a part <<<"$spec"
  for x in "${part[@]}"; do
    if [[ "$x" =~ ^([a-zA-Z_-]+)([0-9]+)-([0-9]+)$ ]]; then
      base="${BASH_REMATCH[1]}"; a="${BASH_REMATCH[2]}"; b="${BASH_REMATCH[3]}"
      for i in $(seq "$a" "$b"); do echo "${base}${i}"; done
    else
      echo "$x"
    fi
  done
}

discover_sboxes_ps(){
  command -v docker >/dev/null 2>&1 || return 0
  docker ps -a --format '{{.Names}}' | grep -E "^${SBOX_PREFIX}[0-9]+$" | sort -V
}

# ============= ADMIN JWT =============
admin_jwt_from_cache(){ [[ -s "$ADMIN_JWT_FILE" ]] && tr -d '\r\n' < "$ADMIN_JWT_FILE"; }
save_admin_jwt(){ printf '%s' "$1" >"$ADMIN_JWT_FILE"; chmod 600 "$ADMIN_JWT_FILE" || true; }

api_post(){ # body từ stdin
  local path="$1"
  curl -sS --fail --connect-timeout 8 --max-time 30 \
    -H 'Content-Type: application/json' -d @- "${UR_API%/}${path}"
}

fetch_admin_jwt_with_auth_code(){
  local out by
  out="$(jq -nc --arg c "$AUTH_CODE" '{auth_code:$c}' | api_post "/auth/code-login" || true)"
  $DEBUG && echo "[DBG] resp code-login: $out" >&2 || true
  by="$(echo "$out" | jq -r '.by_jwt // empty')"
  [[ -n "$by" ]] || die "Đổi AUTH_CODE thất bại: $out"
  printf '%s' "$by"
}
fetch_admin_jwt_with_password(){
  local out by
  out="$(jq -nc --arg u "$USER_AUTH" --arg p "$PASSWORD" \
        '{user_auth:$u, password:$p}' | api_post "/auth/login-with-password" || true)"
  $DEBUG && echo "[DBG] resp login-with-password: $out" >&2 || true
  by="$(echo "$out" | jq -r '.by_jwt // .network.by_jwt // empty')"
  [[ -n "$by" ]] || die "login-with-password chưa ra JWT (có thể cần 2FA): $out"
  printf '%s' "$by"
}

get_fresh_admin_jwt(){
  local cached; cached="$(admin_jwt_from_cache || true)"
  if [[ -n "$cached" ]] && ! jwt_about_to_expire "$cached" "$ADMIN_JWT_RENEW_BEFORE"; then
    printf '%s' "$cached"; return 0
  fi
  local new
  if [[ -n "$AUTH_CODE" ]]; then
    info "Làm mới ADMIN_JWT từ AUTH_CODE ..."
    new="$(fetch_admin_jwt_with_auth_code)"
  else
    info "Làm mới ADMIN_JWT bằng USER_AUTH/PASSWORD ..."
    new="$(fetch_admin_jwt_with_password)"
  fi
  save_admin_jwt "$new"; printf '%s' "$new"
}

# ============= CLIENT JWT =============
jwt_dir_for_sbox(){ echo "${JWT_DIR_BASE}/.urnetwork-$1"; }
jwt_file_for_sbox(){ echo "$(jwt_dir_for_sbox "$1")/jwt"; }

issue_client_jwt(){
  local desc="$1" spec="${2:-docker-ur:g4}" admin="$3"
  local payload out http url
  url="${UR_API%/}/network/auth-client"
  payload="$(jq -nc --arg d "$desc" --arg s "$spec" '{description:$d, device_spec:$s}')"
  out="$(curl -sS -w $'\n%{http_code}' --connect-timeout 8 --max-time 30 \
          -H 'Content-Type: application/json' \
          -H "Authorization: Bearer ${admin}" \
          --data-binary "$payload" \
          "$url" 2>/dev/null || true)"
  http="${out##*$'\n'}"; out="${out%$'\n'*}"
  $DEBUG && echo "[DBG] auth-client HTTP=$http resp=$out" >&2 || true
  if [[ "$http" != "200" && "$http" != "201" ]]; then
    warn "auth-client HTTP=$http | url=$url | payload=$(echo "$payload" | tr -d '\n') | resp=$out"
    echo ""; return 1
  fi
  jq -r '.by_client_jwt // empty' <<<"$out"
}

ensure_client_jwt_for(){
  local s="$1" jwt_file dir admin jwt
  dir="$(jwt_dir_for_sbox "$s")"; jwt_file="$(jwt_file_for_sbox "$s")"
  mkdir -p "$dir"

  if [[ -s "$jwt_file" ]]; then
    jwt="$(tr -d '\r\n' < "$jwt_file")"
    if ! jwt_about_to_expire "$jwt" "$CLIENT_JWT_RENEW_BEFORE"; then
      info "$s: JWT OK (giữ nguyên)"; return 0
    fi
    info "$s: JWT sắp hết hạn → gia hạn..."
  else
    info "$s: cấp JWT mới..."
  fi

  admin="$(get_fresh_admin_jwt)"
  local new; new="$(issue_client_jwt "$s" "docker-ur:g4" "$admin")"
  [[ -n "$new" ]] || die "$s: Không cấp được client JWT."
  printf '%s' "$new" >"$jwt_file"; chmod 600 "$jwt_file" || true
  info "$s: ✓ đã lưu $(basename "$jwt_file")"
}

# ============= ROUTE SOURCE =============
build_route_list(){
  if [[ -n "$ROUTES" ]]; then
    gen_from_routes "$ROUTES"
    return
  fi
  if [[ -n "$COUNT" ]]; then
    gen_from_count "$COUNT" "$SBOX_PREFIX"
    return
  fi
  # fallback: docker ps
  discover_sboxes_ps
}

# ============= CLI =============
usage(){
  cat <<'EOF'
Usage:
  ur-get-jwts-v2 auth
  ur-get-jwts-v2 up
  ur-get-jwts-v2 renew

Cách chỉ định routes (ưu tiên theo thứ tự):
  1) ROUTES="csbox1,csbox2,csbox5-10"
  2) COUNT=30  (kèm SBOX_PREFIX=csbox)
  3) (fallback) dò Docker: grep -E "^${SBOX_PREFIX}[0-9]+$"

ENV: UR_API, AUTH_CODE hoặc (USER_AUTH,PASSWORD), SBOX_PREFIX, COUNT, ROUTES,
     JWT_DIR_BASE, ADMIN_JWT_RENEW_BEFORE, CLIENT_JWT_RENEW_BEFORE, DEBUG
EOF
}

cmd_auth(){ need jq; need curl; get_fresh_admin_jwt >/dev/null; info "✔ ADMIN_JWT OK (cache: $ADMIN_JWT_FILE)"; }
cmd_up(){
  need jq; need curl
  local list; list="$(build_route_list || true)"
  [[ -n "$list" ]] || die "Không có route nào. Hãy dùng COUNT=... hoặc ROUTES=..."
  info "Routes:"; echo "$list" | xargs -I{} echo " - {}"
  while read -r s; do [[ -n "$s" ]] && ensure_client_jwt_for "$s"; done <<< "$list"
  info "✅ Hoàn tất JWT."
}
cmd_renew(){ cmd_up; }

case "${1:-}" in
  auth)   cmd_auth ;;
  up)     cmd_up ;;
  renew)  cmd_renew ;;
  ""|help|-h|--help) usage ;;
  *) die "Lệnh không hợp lệ. Xem: $0 help" ;;
esac
